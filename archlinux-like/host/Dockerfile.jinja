ARG ARCH={{ host_arch }}
FROM lopsided/archlinux:devel

# Install deps and clear pacman cache
RUN \
  pacman -Syu --noconfirm distcc which; \
  pacman -Sc --noconfirm || true;

{% if host_arch != "amd64" %}
# Install pre-built cross-compiler toolchains, as per https://archlinuxarm.org/wiki/Distcc_Cross-Compiling
COPY toolchains/* /toolchains/
{% endif %}
COPY scripts/* /scripts/

RUN \
  chmod +x /scripts/* && \
  /scripts/test-arch.sh {{ host_arch }} && rm /scripts/test-arch.sh && \
  /scripts/setup.sh && rm /scripts/setup.sh

CMD /scripts/run-{{ host_arch }}.sh
