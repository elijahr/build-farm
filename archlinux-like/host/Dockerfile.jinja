FROM {{ host_arch|image }}

# Install deps and clear pacman cache
RUN \
  pacman -Syu --noconfirm distcc; \
  pacman -Sc --noconfirm || true;

# Install pre-built cross-compiler toolchains, as per https://archlinuxarm.org/wiki/Distcc_Cross-Compiling
COPY toolchains/* /toolchains/
COPY etc/conf.d/* /etc/conf.d/
COPY usr/lib/systemd/system/* /usr/lib/systemd/system/
COPY scripts/* /scripts/

RUN \
  chmod +x /scripts/* && \
  /scripts/setup.sh

# Replace systemctl with docker-friendly version
RUN \
  rm -f /usr/bin/systemctl && \
  ln -s /scripts/systemctl3.py /usr/bin/systemctl

CMD /scripts/run.sh
